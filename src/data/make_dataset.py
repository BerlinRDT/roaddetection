# -*- coding: utf-8 -*-

import click
import logging
from pathlib import Path
from dotenv import find_dotenv, load_dotenv
from raster import Raster
from utils import get_meta_data_filename, get_rgb_filename
from spatial_index import create_spatial_index
import kml2geojson as k2g
import toml

# TODOs:
# 2. implement concurrent processing to speed up tile generation

def is_analytic_tif(r_analytic_name, satimg_file_endings):
    """Return True if image is of 'analytic' type."""
    return r_analytic_name.endswith(satimg_file_endings)

def name_begins_with_prefix(r_analytic_name, raw_prefix):
    """Return True if prefix is not None and image file has specific prefix."""
    return r_analytic_name.startswith(raw_prefix) if raw_prefix else True

def is_raster_from_desired_region(r_analytic_name, region, satimg_list):
    """Return True if image is from region specified by user."""
    if region == "all":
        return True
    logger = logging.getLogger(__name__)
    filtered_by_region = satimg_list.loc[satimg_list.directory.str.contains(region, case=False)]
    shouldIgnore = filtered_by_region.loc[filtered_by_region.analyticImgName.str.contains(r_analytic_name)].empty
    if shouldIgnore:
        logger.info("Ignoring raster {} because of region filter {}".format(r_analytic_name, region))
    return not shouldIgnore

def should_make_tiles_from(r_analytic_name, raw_prefix, satimg_file_endings, region, satimg_list):
    """Return True if image satisfies criteria for tile generation."""
    return is_analytic_tif(r_analytic_name, satimg_file_endings) and \
           name_begins_with_prefix(r_analytic_name, raw_prefix) and \
           is_raster_from_desired_region(r_analytic_name, region, satimg_list)

def convert_kml_to_geojson(labels_path):
    """Generate geojson file from kml/kmz file."""
    logger = logging.getLogger(__name__)
    for file in Path(labels_path).iterdir():
        if file.name.endswith(('.kml', 'kmz')):
            logger.info('Generating geojson from {}'.format(file.name))
            kmlpath = '{}/{}'.format(labels_path, file.name)
            k2g.convert(kmlpath, labels_path)


@click.command()
@click.argument('config_file', type=click.File('r'))
@click.argument('input_filepath', type=click.Path(exists=True))
@click.argument('output_filepath', type=click.Path())
def main(config_file, input_filepath, output_filepath):
    """Generate satellite image tiles."""
    logger = logging.getLogger(__name__)
    # read parameters governing creation of tiles (will create
    # a nested dictionary structure )
    par = toml.load(config_file)

    # extract parameters from the nested dictionary
    # structure generated by toml.load and check them if reasonable:
    # - list of satellite images (satimg), region filter
    satimg_list = par["satimg"]["satimg_list"]
    region = par["satimg"]["region"]

    # - file name prefix
    raw_prefix = par["satimg"]["raw_prefix"]
    if (raw_prefix == "None") or (raw_prefix == ""):
        raw_prefix = None

    # - file name endings (must be converted to tuple)
    satimg_file_endings = (par["satimg"]["satimg_file_endings"])
    if not isinstance(satimg_file_endings, tuple):
        satimg_file_endings = tuple(satimg_file_endings)

    # - intensity scaling of satimgs
    scaling_type = par["satimg"]["scaling_type"]
    if not scaling_type in ("percentile", "equalize_adapthist"):
        raise Exception("scaling_type must be 'percentile' or 'equalize_adapthist'")

    # - number type of output image files (should be "uint8")
    dtype = par["satimg"]["dtype"]
    if not dtype in ("uint8", "uint16"):
        raise Exception("dtype must be 'uint8' or 'uint16'")

    # - size of image tiles
    window_size = par["satimg"]["window_size"]
    if window_size < 64:
        raise Exception("a window size < 64 does not make sense")

    # - overlap of image tiles
    overlap = par["satimg"]["overlap"]
    if not (0.0 <= overlap < 1.0):
        raise Exception("overlap must be in [0.0 1.0[")

    logger.info('making tiles from region {} into folder {} with raw image filter {}'.format(region,
                                                                                             output_filepath,
                                                                                             raw_prefix or "None"))
    images_path = "{}/images".format(input_filepath)
    labels_path = "{}/labels".format(input_filepath)

    convert_kml_to_geojson(labels_path)
    idx = create_spatial_index(labels_path)
    
    for r_analytic in Path(images_path).iterdir():
        if should_make_tiles_from(r_analytic.name,
                                  raw_prefix,
                                  satimg_file_endings,
                                  region,
                                  satimg_list):

            meta_data_filename = get_meta_data_filename(images_path, r_analytic.name)
            r_visual_rgb_filename = get_rgb_filename(images_path, r_analytic.name)
            # instantiate raster class
            raster = Raster(r_analytic, r_visual_rgb_filename, meta_data_filename)
            # ** create tiles **
            raster.to_tiles(output_path=output_filepath,
                            window_size=window_size,
                            idx=idx,
                            overlap=overlap,
                            dtype=dtype,
                            scaling_type=scaling_type)



if __name__ == '__main__':
    log_fmt = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    logging.basicConfig(level=logging.INFO, format=log_fmt)

    # not used in this stub but often useful for finding various files
    project_dir = Path(__file__).resolve().parents[2]

    # find .env automagically by walking up directories until it's found, then
    # load up the .env entries as environment variables
    load_dotenv(find_dotenv())

    main()
